<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Manage Funds - Back2Roots</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background: #f5f7fa;
      color: #333;
    }
    h1 {
      color: #27ae60;
    }
    input[type="text"], input[type="date"], input[type="number"] {
      width: 100%;
      padding: 8px 10px;
      margin-bottom: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    button {
      background: #27ae60;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: 1rem;
      margin-right: 10px;
    }
    button:hover {
      background: #1e8449;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      user-select: none;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }
    th {
      background: #27ae60;
      color: white;
      cursor: pointer;
      user-select: none;
    }
    tr.editing td {
      background: #e8f5e9;
    }
    #searchInput {
      width: 300px;
      padding: 8px 10px;
      margin-bottom: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 12px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .modal-buttons {
      text-align: right;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Manage Funds</h1>

  <input type="text" id="searchInput" placeholder="Search fund transactions..." aria-label="Search fund transactions" />

  <table id="fundsTable" aria-label="List of fund transactions">
    <thead>
      <tr>
        <th data-key="date">Date ▲▼</th>
        <th data-key="donor">Donor ▲▼</th>
        <th data-key="amount">Amount ▲▼</th>
        <th data-key="purpose">Purpose ▲▼</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <!-- Fund transactions inserted here -->
    </tbody>
  </table>

  <h2>Add New Fund Transaction</h2>
  <form id="fundForm" aria-label="Add new fund transaction form">
    <label for="date">Date</label>
    <input type="date" id="date" required />

    <label for="donor">Donor</label>
    <input type="text" id="donor" required />

    <label for="amount">Amount</label>
    <input type="number" id="amount" min="1" required />

    <label for="purpose">Purpose</label>
    <input type="text" id="purpose" required />

    <button type="submit">Add Transaction</button>
  </form>

  <!-- Delete confirmation modal -->
  <div id="deleteModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalDesc">
    <div class="modal-content">
      <h3 id="modalTitle">Confirm Delete</h3>
      <p id="modalDesc">Are you sure you want to delete this transaction?</p>
      <div class="modal-buttons">
        <button id="confirmDeleteBtn">Yes, Delete</button>
        <button id="cancelDeleteBtn">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    let funds = [
      { id: 1, date: "2025-01-15", donor: "John Doe", amount: 500, purpose: "Scholarship Fund" },
      { id: 2, date: "2025-02-10", donor: "Jane Smith", amount: 1200, purpose: "Alumni Meet" }
    ];

    const fundsTableBody = document.querySelector("#fundsTable tbody");
    const fundForm = document.getElementById("fundForm");
    const searchInput = document.getElementById("searchInput");
    const deleteModal = document.getElementById("deleteModal");
    const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
    const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");

    let deleteId = null;
    let sortKey = null;
    let sortAsc = true;

    function renderFunds() {
      let filtered = funds.filter(f => {
        const q = searchInput.value.toLowerCase();
        return (
          f.donor.toLowerCase().includes(q) ||
          f.purpose.toLowerCase().includes(q) ||
          f.date.includes(q) ||
          f.amount.toString().includes(q)
        );
      });

      if (sortKey) {
        filtered.sort((a,b) => {
          if (sortKey === "amount") {
            return sortAsc ? a.amount - b.amount : b.amount - a.amount;
          }
          if (a[sortKey] < b[sortKey]) return sortAsc ? -1 : 1;
          if (a[sortKey] > b[sortKey]) return sortAsc ? 1 : -1;
          return 0;
        });
      }

      fundsTableBody.innerHTML = "";
      filtered.forEach(fund => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="editable" data-key="date">${fund.date}</td>
          <td class="editable" data-key="donor">${escapeHtml(fund.donor)}</td>
          <td class="editable" data-key="amount">${fund.amount}</td>
          <td class="editable" data-key="purpose">${escapeHtml(fund.purpose)}</td>
          <td>
            <button class="editBtn" aria-label="Edit transaction from ${fund.donor}">Edit</button>
            <button class="deleteBtn" aria-label="Delete transaction from ${fund.donor}">Delete</button>
          </td>
        `;
        fundsTableBody.appendChild(tr);
      });
      attachRowEventListeners();
    }

    function escapeHtml(text) {
      return text.replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      })[m]);
    }

    function attachRowEventListeners() {
      document.querySelectorAll(".deleteBtn").forEach(btn => {
        btn.onclick = e => {
          const row = e.target.closest("tr");
          const id = getFundIdFromRow(row);
          deleteId = id;
          deleteModal.style.display = "flex";
          deleteModal.focus();
        };
      });

      document.querySelectorAll(".editBtn").forEach(btn => {
        btn.onclick = e => {
          const row = e.target.closest("tr");
          if (row.classList.contains("editing")) return; // already editing
          row.classList.add("editing");
          for (let i=0; i<=3; i++) {
            const cell = row.children[i];
            const key = cell.getAttribute("data-key");
            const val = cell.textContent;
            if (key === "amount") {
              const input = document.createElement("input");
              input.type = "number";
              input.min = "1";
              input.value = val;
              cell.textContent = "";
              cell.appendChild(input);
            } else if (key === "date") {
              const input = document.createElement("input");
              input.type = "date";
              input.value = val;
              cell.textContent = "";
              cell.appendChild(input);
            } else {
              const input = document.createElement("input");
              input.type = "text";
              input.value = val;
              cell.textContent = "";
              cell.appendChild(input);
            }
          }
          // Change buttons
          const actionCell = row.children[4];
          actionCell.innerHTML = `
            <button class="saveBtn" aria-label="Save transaction changes">Save</button>
            <button class="cancelBtn" aria-label="Cancel editing">Cancel</button>
          `;
          actionCell.querySelector(".saveBtn").onclick = () => saveEdit(row);
          actionCell.querySelector(".cancelBtn").onclick = () => cancelEdit(row);
        };
      });
    }

    function getFundIdFromRow(row) {
      // Find fund by matching all fields (date, donor, amount, purpose)
      const date = row.children[0].textContent.trim();
      const donor = row.children[1].textContent.trim();
      const amount = parseFloat(row.children[2].textContent.trim());
      const purpose = row.children[3].textContent.trim();
      return funds.find(f => f.date === date && f.donor === donor && f.amount === amount && f.purpose === purpose)?.id;
    }

    function saveEdit(row) {
      const id = getFundIdFromRow(row);
      if (!id) {
        alert("Error identifying transaction.");
        cancelEdit(row);
        return;
      }
      const date = row.children[0].querySelector("input").value;
      const donor = row.children[1].querySelector("input").value.trim();
      const amount = parseFloat(row.children[2].querySelector("input").value);
      const purpose = row.children[3].querySelector("input").value.trim();

      if (!date || !donor || !amount || !purpose) {
        alert("All fields are required.");
        return;
      }
      if (amount <= 0 || isNaN(amount)) {
        alert("Amount must be a positive number.");
        return;
      }

      const fund = funds.find(f => f.id === id);
      fund.date = date;
      fund.donor = donor;
      fund.amount = amount;
      fund.purpose = purpose;

      row.classList.remove("editing");
      renderFunds();
    }

    function cancelEdit(row) {
      row.classList.remove("editing");
      renderFunds();
    }

    fundForm.addEventListener("submit", e => {
      e.preventDefault();
      const date = document.getElementById("date").value;
      const donor = document.getElementById("donor").value.trim();
      const amount = parseFloat(document.getElementById("amount").value);
      const purpose = document.getElementById("purpose").value.trim();

      if (!date || !donor || !amount || !purpose) {
        alert("Please fill all fields.");
        return;
      }
      if (amount <= 0 || isNaN(amount)) {
        alert("Amount must be a positive number.");
        return;
      }

      const newFund = {
        id: funds.length ? funds[funds.length - 1].id + 1 : 1,
        date,
        donor,
        amount,
        purpose
      };

      funds.push(newFund);
      renderFunds();
      fundForm.reset();
    });

    searchInput.addEventListener("input", renderFunds);

    // Sorting
    document.querySelectorAll("#fundsTable th[data-key]").forEach(th => {
      th.addEventListener("click", () => {
        const key = th.getAttribute("data-key");
        if (sortKey === key) {
          sortAsc = !sortAsc;
        } else {
          sortKey = key;
          sortAsc = true;
        }
        renderFunds();
      });
    });

    // Delete modal buttons
    confirmDeleteBtn.onclick = () => {
      if (deleteId !== null) {
        funds = funds.filter(f => f.id !== deleteId);
        deleteId = null;
        deleteModal.style.display = "none";
        renderFunds();
      }
    };
    cancelDeleteBtn.onclick = () => {
      deleteId = null;
      deleteModal.style.display = "none";
    };

    // Close modal on outside click or Escape key
    deleteModal.onclick = e => {
      if (e.target === deleteModal) {
        deleteId = null;
        deleteModal.style.display = "none";
      }
    };
    window.addEventListener("keydown", e => {
      if (e.key === "Escape" && deleteModal.style.display === "flex") {
        deleteId = null;
        deleteModal.style.display = "none";
      }
    });

    renderFunds();
  </script>
</body>
</html>